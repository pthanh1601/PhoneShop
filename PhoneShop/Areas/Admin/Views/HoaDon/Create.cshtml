@model PhoneShop.ViewModels.CreateHoaDon
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

@{
    ViewData["Title"] = "Quản Lý Hóa Đơn";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.Admin.cshtml";
}

<h2>Thêm Hóa Đơn</h2>

<form asp-action="Create" method="post">
    <!-- Thông tin hóa đơn -->
    <div class="form-group">
        <label for="MaKh">Khách hàng:</label>
        <input asp-for="HoaDon.MaKh" class="form-control" />
    </div>
    <div class="form-group">
        <label for="DiaChi">Địa chỉ:</label>
        <input asp-for="HoaDon.DiaChi" class="form-control" />
    </div>
    <div class="form-group">
        <label for="MaTrangThai">Trạng thái:</label>
        <select asp-for="HoaDon.MaTrangThai" asp-items="@(new SelectList(Model.TrangThais, "MaTrangThai", "TenTrangThai"))" class="form-control"></select>
    </div>

    <hr />
    <h3>Hàng hóa</h3>
    <div style="display: flex;">
        <!-- Bộ lọc tìm kiếm hàng hóa -->
        <div style="width: 20%;">
            <label for="searchKeyword">Tìm kiếm:</label>
            <input type="text" id="searchKeyword" class="form-control" placeholder="Nhập từ khóa..." />
            <br />
            <label for="filterCategory">Loại hàng hóa:</label>
            <select id="filterCategory" class="form-control">
                <option value="">-- Tất cả --</option>
                @foreach (var category in Model.HangHoas.Select(h => h.MaLoaiNavigation).Distinct())
                {
                    <option value="@category.MaLoai">@category.TenLoai</option>
                }
            </select>
            <br />
            <button type="button" id="searchButton" class="btn btn-primary">Tìm kiếm</button>
        </div>

        <!-- Bảng danh sách hàng hóa -->
        <div style="width: 80%;">
            <table id="productTable" class="table table-bordered mt-3">
                <thead>
                    <tr>
                        <th>Tên hàng hóa</th>
                        <th>Đơn giá</th>
                        <th>Hành động</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var hangHoa in Model.HangHoas)
                    {
                        <tr>
                            <td>@hangHoa.TenHh</td>
                            <td>@hangHoa.DonGia</td>
                            <td>
                                <button type="button" class="btn btn-success" onclick="addToDetails(@hangHoa.MaHh, '@hangHoa.TenHh', @hangHoa.DonGia)">Thêm</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <hr />
    <h3>Chi tiết hóa đơn</h3>
    <table id="detailsTable" class="table table-bordered">
        <thead>
            <tr>
                <th>Tên hàng hóa</th>
                <th>Số lượng</th>
                <th>Đơn giá</th>
                <th>Thành tiền</th>
                <th>Hành động</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <hr />
    <button type="submit" class="btn btn-primary">Lưu hóa đơn</button>
</form>

<script>
    $(document).ready(function () {
        // Tìm kiếm và lọc hàng hóa
        $("#searchButton").click(function () {
            const keyword = $("#searchKeyword").val();
            const categoryId = $("#filterCategory").val();

            $.post("/Admin/HoaDon/SearchProducts", { keyword: keyword, categoryId: categoryId }, function (data) {
                // Xóa các dòng hiện tại trong bảng và thêm kết quả tìm kiếm vào bảng
                $("#productTable tbody").empty();
                data.forEach(function (hangHoa) {
                    const row = `
                        <tr>
                            <td>${hangHoa.tenHh}</td>
                            <td>${hangHoa.donGia}</td>
                            <td>
                                <button type="button" class="btn btn-success" onclick="addToDetails(${hangHoa.maHh}, '${hangHoa.tenHh}', ${hangHoa.donGia})">Thêm</button>
                            </td>
                        </tr>
                    `;
                    $("#productTable tbody").append(row);
                });
            });
        });
    });

    // Thêm sản phẩm vào bảng chi tiết hóa đơn
    function addToDetails(maHh, tenHh, donGia) {
        const row = `
            <tr>
                <td>${tenHh}</td>
                <td><input type="number" name="ChiTietHds[0].SoLuong" value="1" onchange="updateTotal(this, ${donGia})" class="form-control" /></td>
                <td>${donGia}</td>
                <td><span>${donGia}</span></td>
                <td><button type="button" class="btn btn-danger" onclick="removeRow(this)">Xóa</button></td>
            </tr>
        `;
        $("#detailsTable tbody").append(row);
    }

    // Cập nhật thành tiền khi thay đổi số lượng
    function updateTotal(input, donGia) {
        const quantity = $(input).val();
        const total = quantity * donGia;
        $(input).closest("tr").find("span").text(total);
    }

    // Xóa dòng khỏi bảng chi tiết hóa đơn
    function removeRow(button) {
        $(button).closest("tr").remove();
    }
</script>

